name: Update Flake Version

on:
  schedule:
    # Run every day at midnight
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-glide:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Check for updates and patch flake
        id: update
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/glide-browser/glide/releases/latest | jq -r .tag_name)
          NEW_VERSION=${LATEST_TAG#v}

          CURRENT_VERSION=$(grep 'version = ' flake.nix | head -n 1 | cut -d '"' -f 2)

          echo "Current: $CURRENT_VERSION"
          echo "Latest:  $NEW_VERSION"

          if [ "$NEW_VERSION" == "$CURRENT_VERSION" ]; then
            echo "Version matches. No update needed."
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Update found! Patching flake..."
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          sed -i "s/version = \"$CURRENT_VERSION\";/version = \"$NEW_VERSION\";/" flake.nix

          declare -A FILES
          FILES["x86_64-linux"]="glide.linux-x86_64.tar.xz"
          FILES["aarch64-linux"]="glide.linux-aarch64.tar.xz"
          FILES["x86_64-darwin"]="glide.macos-x86_64.dmg"
          FILES["aarch64-darwin"]="glide.macos-aarch64.dmg"

          for SYSTEM in "${!FILES[@]}"; do
            FILENAME="${FILES[$SYSTEM]}"
            URL="https://github.com/glide-browser/glide/releases/download/${NEW_VERSION}/${FILENAME}"
            
            echo "Prefetching $SYSTEM from $URL..."
            NEW_HASH=$(nix-prefetch-url "$URL" --type sha256)
            
            sed -i "/\"$SYSTEM\"/,/sha256/ s/sha256 = \".*\";/sha256 = \"$NEW_HASH\";/" flake.nix
          done

      - name: Verify Flake (Dry Run)
        if: steps.update.outputs.updated == 'true'
        run: |
          nix flake show

      - name: Create Pull Request
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update glide-browser to ${{ steps.update.outputs.new_version }}"
          title: "Update Glide Browser to ${{ steps.update.outputs.new_version }}"
          body: |
            Automated update for Glide Browser.
            
            **Version:** `${{ steps.update.outputs.new_version }}`
            
            Auto-generated by GitHub Actions.
          branch: "auto-update-glide-${{ steps.update.outputs.new_version }}"
          delete-branch: true
